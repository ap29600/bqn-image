âŸ¨FromPNMâŸ© â‡

ReadNat     â† 10âŠ¸Ã—âŠ¸+ËœÂ´âˆ˜âŒ½-âŸœ48
Part        â† (Â¯1+âŠ¢Ã—Â·+`>âŸœÂ»)âŠ¸âŠ”
IsNum       â† ('0'-@)âŠ¸â‰¤âˆ§â‰¤âŸœ('9'-@)
FillReshape â† {ğ•¨â¥Š(Ã—Â´ğ•¨)â†‘ğ•©âˆ¾0}

# NOTE: the plain text formats allow comments to appear the middle of tokens
# without breaking them, so it's fine to remove the comments from the bulk of
# the data without worrying about tokens merging.
RemoveComments â† {
  nl â† (â‰ ğ•©)âˆ¾Ëœ/10=ğ•©
  c â† /('#'-@)=ğ•©
  m â† Â¯1âŠ¸Â»âŠ¸â‰  i â† nlâ‹c
  ğ•©/Ëœ 1+`(1+nlâŠËœm/i)-â—‹((â‰ ğ•©)â†‘/â¼)m/c
}

_readRawData â† {
  wâ€¿hâ€¿lvğ•—_ğ•£ğ•©:
  pd â† (hâ€¿wâˆ¾ğ•—)FillReshape(lvâ‰¥256)â—¶âŸ¨âŠ¢, +Â´Ë˜256â€¿1Ã—â‰1â†‘â€¿2âŠ¸â¥ŠâŸ©ğ•©
  pdâ€¿lv
}

_readAsciiData â† {
  wâ€¿hâ€¿lvğ•—_ğ•£ğ•©:
  pd â† (hâ€¿wâˆ¾ğ•—)FillReshape ReadNatÂ¨IsNumâŠ¸Part ğ•©
  pdâ€¿lv
}

ReadAsciiBoolData â† {
  wâ€¿hâ€¿lvğ•Šğ•©:
  pd â† hâ€¿w FillReshape(mâˆ¨('0'-@)=ğ•©)/mâ†('1'-@)=ğ•©
  pdâ€¿lv
}

ReadRawBoolData â† {
  wâ€¿hâ€¿lvğ•Šğ•©:
  pd â† hâ€¿w FillReshape â¥ŠâŒ½Ë˜âˆ˜â€¿8â¥ŠâŸ¨8,1â€¿'u'âŸ©â€¢bit._cast ğ•©
  pdâ€¿lv
}

ReadTokens â† {
  toks â† âŸ¨âŸ©
  tok â† âŸ¨âŸ©
  comment â† 0
  rest â† {toksâˆ¾â†©ReadNatâŠ0 tok â‹„ tokâ†©âŸ¨âŸ© â‹„ ğ•©}âˆ˜{
    0=â‰ ğ•©?          ğ•©;
    ('#'-@)=âŠ‘ğ•©?    commentâ†©1 â‹„ ğ•Š1â†“ğ•©; # initiate new comment
    commentâˆ§10=âŠ‘ğ•©? commentâ†©0 â‹„ ğ•Š1â†“ğ•©; # newline terminates comments
    comment?       ğ•Š1â†“ğ•©;
    IsNumâŠ‘ğ•©?       tokâˆ¾â†©âŠğ•© â‹„ ğ•Š1â†“ğ•©;
    0=â‰ tok?        ğ•Š1â†“ğ•©; # continue looking
    1â†“ğ•© # token is formed. consume the breaking character and return.
  }âŸğ•¨ ğ•©
  toksâ€¿rest
}

# Lookup table for file types.
magic_bytesâ€¿header_procsâ€¿data_procs â† <Ë˜â‰[
  âŸ¨"P1"-@, ((âˆ¾âŸœ1âŒ¾âŠ‘)2âŠ¸ReadTokens), ReadAsciiBoolDataâŸœRemoveCommentsâŸ©,
  âŸ¨"P2"-@, (       3âŠ¸ReadTokens), âŸ¨ âŸ©_readAsciiDataâŸœRemoveCommentsâŸ©,
  âŸ¨"P3"-@, (       3âŠ¸ReadTokens), âŸ¨3âŸ©_readAsciiDataâŸœRemoveCommentsâŸ©,
  âŸ¨"P4"-@, ((âˆ¾âŸœ1âŒ¾âŠ‘)2âŠ¸ReadTokens), ReadRawBoolData                 âŸ©,
  âŸ¨"P5"-@, (       3âŠ¸ReadTokens), âŸ¨ âŸ©_readRawData                 âŸ©,
  âŸ¨"P6"-@, (       3âŠ¸ReadTokens), âŸ¨3âŸ©_readRawData                 âŸ©
]

FromPNM â‡ {
  mbâ€¿f â† 2(â†‘â‹ˆâ†“)ğ•©-@
  iâ†âŠ‘magic_bytesâŠâ‹ˆmb
  âŸ¨@+mbâŸ©âˆ¾Ëœ iâ—¶data_procsÂ´ iâ—¶header_procs f
}
